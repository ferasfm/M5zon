-- ===================================
-- ╪к╪н╪п┘К╪л ╪н╪▓┘Е POS ╪з┘Д┘В╪п┘К┘Е╪й - ╪о╪╖┘И╪й ╪и╪о╪╖┘И╪й
-- ===================================

-- ===================================
-- ╪з┘Д╪о╪╖┘И╪й 1: ╪╣╪▒╪╢ ╪м┘Е┘К╪╣ ╪з┘Д┘В╪╖╪╣ ╪з┘Д┘Е╪н╪к┘Е┘Д╪й
-- ===================================
-- ╪┤╪║┘С┘Д ┘З╪░╪з ╪г┘И┘Д╪з┘Л ┘Д╪▒╪д┘К╪й ╪з┘Д╪и┘К╪з┘Ж╪з╪к

SELECT 
    id,
    serial_number as "╪и╪з╪▒ ┘Г┘И╪п",
    cost_price as "╪з┘Д╪к┘Г┘Д┘Б╪й",
    TO_CHAR(purchase_date, 'YYYY-MM-DD') as "╪к╪з╪▒┘К╪о ╪з┘Д╪з╪│╪к┘Д╪з┘Е",
    supplier_id as "╪з┘Д┘Е┘И╪▒╪п",
    destination_client_id as "╪з┘Д╪╣┘Е┘К┘Д",
    purchase_reason as "╪з┘Д╪│╪и╪и",
    bundle_group_id as "┘Е╪╣╪▒┘Б ╪з┘Д╪н╪▓┘Е╪й",
    bundle_name as "╪з╪│┘Е ╪з┘Д╪н╪▓┘Е╪й"
FROM inventory_items
WHERE purchase_date >= '2024-01-01'  -- ╪╣╪п┘С┘Д ╪з┘Д╪к╪з╪▒┘К╪о ╪н╪│╪и ╪з┘Д╪н╪з╪м╪й
AND bundle_group_id IS NULL          -- ┘Б┘В╪╖ ╪з┘Д┘В╪╖╪╣ ╪з┘Д╪к┘К ┘Д┘К╪│╪к ┘Б┘К ╪н╪▓┘Е╪й
ORDER BY purchase_date DESC, supplier_id
LIMIT 50;

-- ===================================
-- ╪з┘Д╪о╪╖┘И╪й 2: ╪к╪н╪п┘К╪п ╪з┘Д┘В╪╖╪╣ ╪з┘Д╪к┘К ╪к┘Ж╪к┘Е┘К ┘Д╪н╪▓┘Е╪й POS
-- ===================================
-- ╪з╪и╪н╪л ┘Б┘К ╪з┘Д┘Ж╪к╪з╪ж╪м ╪г╪╣┘Д╪з┘З ╪╣┘Ж:
-- - ┘Е╪м┘Е┘И╪╣╪й ┘В╪╖╪╣ ╪з╪│╪к┘Д┘Е╪к ┘Е╪╣╪з┘Л
-- - ┘Ж┘Б╪│ ╪з┘Д╪к╪з╪▒┘К╪о
-- - ┘Ж┘Б╪│ ╪з┘Д┘Е┘И╪▒╪п
-- - ┘Ж┘Б╪│ ╪з┘Д╪╣┘Е┘К┘Д

-- ===================================
-- ╪з┘Д╪о╪╖┘И╪й 3: ╪к╪н╪п┘К╪л ╪н╪▓┘Е╪й POS ╪з┘Д╪г┘И┘Д┘Й
-- ===================================
-- ╪з╪│╪к╪и╪п┘Д ╪з┘Д╪г╪▒┘В╪з┘Е ╪з┘Д╪к╪│┘Д╪│┘Д┘К╪й ╪и╪з┘Д╪г╪▒┘В╪з┘Е ╪з┘Д╪н┘В┘К┘В┘К╪й

-- ┘Е╪л╪з┘Д: ╪н╪▓┘Е╪й POS #1
UPDATE inventory_items
SET 
    bundle_group_id = 'bundle_pos_001',
    bundle_name = '┘Ж┘В╪╖╪й ╪и┘К╪╣ ┘Г╪з┘Е┘Д╪й POS'
WHERE serial_number IN (
    'SERIAL_001',  -- тЪая╕П ╪з╪│╪к╪и╪п┘Д ╪и╪з┘Д╪г╪▒┘В╪з┘Е ╪з┘Д╪н┘В┘К┘В┘К╪й
    'SERIAL_002',
    'SERIAL_003',
    'SERIAL_004'
);

-- ===================================
-- ╪з┘Д╪о╪╖┘И╪й 4: ╪з┘Д╪к╪н┘В┘В ┘Е┘Ж ╪з┘Д┘Ж╪к┘К╪м╪й
-- ===================================

SELECT 
    bundle_group_id as "┘Е╪╣╪▒┘Б ╪з┘Д╪н╪▓┘Е╪й",
    bundle_name as "╪з╪│┘Е ╪з┘Д╪н╪▓┘Е╪й",
    COUNT(*) as "╪╣╪п╪п ╪з┘Д┘В╪╖╪╣",
    SUM(cost_price) as "╪з┘Д╪к┘Г┘Д┘Б╪й ╪з┘Д╪е╪м┘Е╪з┘Д┘К╪й",
    STRING_AGG(serial_number, ', ') as "╪з┘Д╪г╪▒┘В╪з┘Е ╪з┘Д╪к╪│┘Д╪│┘Д┘К╪й"
FROM inventory_items
WHERE bundle_group_id = 'bundle_pos_001'
GROUP BY bundle_group_id, bundle_name;

-- ===================================
-- ╪з┘Д╪о╪╖┘И╪й 5: ╪к╪н╪п┘К╪л ╪н╪▓┘Е ╪е╪╢╪з┘Б┘К╪й (╪е╪░╪з ┘И╪м╪п╪к)
-- ===================================

-- ╪н╪▓┘Е╪й POS #2
UPDATE inventory_items
SET 
    bundle_group_id = 'bundle_pos_002',
    bundle_name = '┘Ж┘В╪╖╪й ╪и┘К╪╣ ┘Г╪з┘Е┘Д╪й POS'
WHERE serial_number IN (
    'SERIAL_005',  -- тЪая╕П ╪з╪│╪к╪и╪п┘Д ╪и╪з┘Д╪г╪▒┘В╪з┘Е ╪з┘Д╪н┘В┘К┘В┘К╪й
    'SERIAL_006',
    'SERIAL_007',
    'SERIAL_008'
);

-- ╪н╪▓┘Е╪й POS #3
UPDATE inventory_items
SET 
    bundle_group_id = 'bundle_pos_003',
    bundle_name = '┘Ж┘В╪╖╪й ╪и┘К╪╣ ┘Г╪з┘Е┘Д╪й POS'
WHERE serial_number IN (
    'SERIAL_009',  -- тЪая╕П ╪з╪│╪к╪и╪п┘Д ╪и╪з┘Д╪г╪▒┘В╪з┘Е ╪з┘Д╪н┘В┘К┘В┘К╪й
    'SERIAL_010',
    'SERIAL_011',
    'SERIAL_012'
);

-- ===================================
-- ╪з┘Д╪о╪╖┘И╪й 6: ╪╣╪▒╪╢ ╪м┘Е┘К╪╣ ╪н╪▓┘Е POS
-- ===================================

SELECT 
    bundle_group_id as "┘Е╪╣╪▒┘Б ╪з┘Д╪н╪▓┘Е╪й",
    bundle_name as "╪з╪│┘Е ╪з┘Д╪н╪▓┘Е╪й",
    COUNT(*) as "╪╣╪п╪п ╪з┘Д┘В╪╖╪╣",
    SUM(cost_price) as "╪з┘Д╪к┘Г┘Д┘Б╪й ╪з┘Д╪е╪м┘Е╪з┘Д┘К╪й",
    TO_CHAR(MIN(purchase_date), 'YYYY-MM-DD') as "╪к╪з╪▒┘К╪о ╪з┘Д╪з╪│╪к┘Д╪з┘Е"
FROM inventory_items
WHERE bundle_name = '┘Ж┘В╪╖╪й ╪и┘К╪╣ ┘Г╪з┘Е┘Д╪й POS'
GROUP BY bundle_group_id, bundle_name
ORDER BY MIN(purchase_date) DESC;

-- ===================================
-- ╪з┘Д╪о╪╖┘И╪й 7: ╪╣╪▒╪╢ ╪к┘Б╪з╪╡┘К┘Д ┘Г┘Д ╪н╪▓┘Е╪й
-- ===================================

SELECT 
    bundle_group_id as "┘Е╪╣╪▒┘Б ╪з┘Д╪н╪▓┘Е╪й",
    serial_number as "╪и╪з╪▒ ┘Г┘И╪п",
    cost_price as "╪з┘Д╪к┘Г┘Д┘Б╪й",
    TO_CHAR(purchase_date, 'YYYY-MM-DD') as "╪з┘Д╪к╪з╪▒┘К╪о"
FROM inventory_items
WHERE bundle_name = '┘Ж┘В╪╖╪й ╪и┘К╪╣ ┘Г╪з┘Е┘Д╪й POS'
ORDER BY bundle_group_id, purchase_date;

-- ===================================
-- тЪая╕П ╪з┘Д╪к╪▒╪з╪м╪╣ ╪╣┘Ж ╪з┘Д╪к╪н╪п┘К╪л (╪е╪░╪з ╪н╪п╪л ╪о╪╖╪г)
-- ===================================

-- ╪е┘Д╪║╪з╪б ╪к╪н╪п┘К╪л ╪н╪▓┘Е╪й ┘Е╪╣┘К┘Ж╪й
-- UPDATE inventory_items
-- SET 
--     bundle_group_id = NULL,
--     bundle_name = NULL
-- WHERE bundle_group_id = 'bundle_pos_001';

-- ╪е┘Д╪║╪з╪б ╪м┘Е┘К╪╣ ╪н╪▓┘Е POS
-- UPDATE inventory_items
-- SET 
--     bundle_group_id = NULL,
--     bundle_name = NULL
-- WHERE bundle_name = '┘Ж┘В╪╖╪й ╪и┘К╪╣ ┘Г╪з┘Е┘Д╪й POS';

-- ===================================
-- ЁЯУЛ ┘Е┘Д╪з╪н╪╕╪з╪к ┘Е┘З┘Е╪й
-- ===================================

/*
тЬЕ ┘Ж╪╡╪з╪ж╪н:
1. ╪┤╪║┘С┘Д ╪з┘Д╪о╪╖┘И╪й 1 ╪г┘И┘Д╪з┘Л ┘Д╪▒╪д┘К╪й ╪з┘Д╪и┘К╪з┘Ж╪з╪к
2. ╪н╪п╪п ╪з┘Д┘В╪╖╪╣ ╪з┘Д╪к┘К ╪к┘Ж╪к┘Е┘К ┘Д┘Г┘Д ╪н╪▓┘Е╪й
3. ╪з╪│╪к╪о╪п┘Е ┘Е╪╣╪▒┘Б ┘Б╪▒┘К╪п ┘Д┘Г┘Д ╪н╪▓┘Е╪й (bundle_pos_001, bundle_pos_002, ...)
4. ╪к╪н┘В┘В ┘Е┘Ж ╪з┘Д┘Ж╪к╪з╪ж╪м ╪и╪╣╪п ┘Г┘Д ╪к╪н╪п┘К╪л
5. ╪з╪н╪к┘Б╪╕ ╪и┘Ж╪│╪о╪й ╪з╪н╪к┘К╪з╪╖┘К╪й

тЪая╕П ╪к╪н╪░┘К╪▒╪з╪к:
1. ┘Д╪з ╪к╪│╪к╪о╪п┘Е ┘Ж┘Б╪│ bundle_group_id ┘Д╪н╪▓┘Е ┘Е╪о╪к┘Д┘Б╪й
2. ╪к╪г┘Г╪п ┘Е┘Ж ╪з┘Д╪г╪▒┘В╪з┘Е ╪з┘Д╪к╪│┘Д╪│┘Д┘К╪й ┘В╪и┘Д ╪з┘Д╪к╪н╪п┘К╪л
3. ╪з╪о╪к╪и╪▒ ╪╣┘Д┘Й ╪н╪▓┘Е╪й ┘И╪з╪н╪п╪й ╪г┘И┘Д╪з┘Л
*/

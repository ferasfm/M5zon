# دليل نظام المصادقة والصلاحيات

## نظرة عامة
تم تطبيق نظام مصادقة وصلاحيات متكامل في التطبيق يتضمن:
- تسجيل الدخول والخروج
- إدارة المستخدمين
- نظام الأدوار والصلاحيات
- تغيير كلمة المرور الإجباري عند أول تسجيل دخول
- حماية الصفحات بناءً على الصلاحيات

## المكونات الرئيسية

### 1. Contexts (السياقات)

#### AuthContext
- **الموقع**: `contexts/AuthContext.tsx`
- **الوظائف**:
  - `login(username, password)` - تسجيل الدخول
  - `logout()` - تسجيل الخروج
  - `changePassword(oldPassword, newPassword)` - تغيير كلمة المرور
  - `user` - معلومات المستخدم الحالي
  - `isAuthenticated` - حالة المصادقة
  - `isLoading` - حالة التحميل

#### PermissionsContext
- **الموقع**: `contexts/PermissionsContext.tsx`
- **الوظائف**:
  - `canView(page)` - التحقق من صلاحية عرض صفحة
  - `canCreate(page)` - التحقق من صلاحية الإنشاء
  - `canEdit(page)` - التحقق من صلاحية التعديل
  - `canDelete(page)` - التحقق من صلاحية الحذف
  - `permissions` - قائمة الصلاحيات الكاملة

### 2. Components (المكونات)

#### Login
- **الموقع**: `components/Login.tsx`
- صفحة تسجيل الدخول الرئيسية
- تحتوي على نموذج اسم المستخدم وكلمة المرور
- عرض الأخطاء والتحقق من البيانات

#### UsersManagement
- **الموقع**: `components/UsersManagement.tsx`
- إدارة المستخدمين (إضافة، تعديل، حذف)
- تعيين الأدوار والصلاحيات
- إعادة تعيين كلمات المرور
- متاحة فقط للمدراء

#### ProtectedRoute
- **الموقع**: `components/ProtectedRoute.tsx`
- مكون لحماية الصفحات
- يتحقق من صلاحيات المستخدم قبل عرض المحتوى
- يعرض رسالة خطأ إذا لم تكن هناك صلاحية

#### ChangePasswordModal
- **الموقع**: `components/ChangePasswordModal.tsx`
- نافذة منبثقة لتغيير كلمة المرور
- إجبارية عند أول تسجيل دخول
- التحقق من قوة كلمة المرور

## قاعدة البيانات

### جداول النظام

#### users
```sql
- id: UUID (Primary Key)
- username: VARCHAR (Unique)
- password_hash: VARCHAR
- full_name: VARCHAR
- email: VARCHAR
- role: VARCHAR (admin, manager, user)
- is_active: BOOLEAN
- must_change_password: BOOLEAN
- is_first_login: BOOLEAN
- last_login: TIMESTAMP
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

#### permissions
```sql
- id: UUID (Primary Key)
- user_id: UUID (Foreign Key -> users.id)
- page: VARCHAR
- can_view: BOOLEAN
- can_create: BOOLEAN
- can_edit: BOOLEAN
- can_delete: BOOLEAN
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

#### password_resets
```sql
- id: UUID (Primary Key)
- user_id: UUID (Foreign Key -> users.id)
- reset_token: VARCHAR
- expires_at: TIMESTAMP
- used: BOOLEAN
- created_at: TIMESTAMP
```

## الأدوار والصلاحيات

### الأدوار المتاحة

1. **admin** (مدير النظام)
   - صلاحيات كاملة على جميع الصفحات
   - إدارة المستخدمين
   - تعيين الصلاحيات

2. **manager** (مدير)
   - صلاحيات كاملة على معظم الصفحات
   - لا يمكنه إدارة المستخدمين

3. **user** (مستخدم)
   - صلاحيات محدودة حسب التعيين
   - عرض فقط في معظم الصفحات

### الصفحات المحمية

- `dashboard` - لوحة التحكم
- `products` - المنتجات
- `receiving` - استلام البضاعة
- `dispatching` - صرف البضاعة
- `dispatch_management` - إدارة التسليمات
- `scrapping` - إتلاف البضاعة
- `suppliers` - الموردون
- `locations` - المواقع والعملاء
- `reports` - التقارير
- `print_templates` - المطالبات المالية
- `users` - إدارة المستخدمين (مدراء فقط)
- `settings` - الإعدادات

## الإعداد الأولي

### 1. إنشاء الجداول
```bash
# تشغيل سكريبت إنشاء الجداول
node scripts/setup-auth-system.js
```

### 2. المستخدم الافتراضي
بعد تشغيل السكريبت، سيتم إنشاء مستخدم مدير افتراضي:
- **اسم المستخدم**: `admin`
- **كلمة المرور**: `admin123`
- **الدور**: `admin`

⚠️ **مهم**: يجب تغيير كلمة المرور عند أول تسجيل دخول!

### 3. الصلاحيات الافتراضية
يتم إنشاء صلاحيات كاملة للمدير على جميع الصفحات تلقائياً.

## الاستخدام

### تسجيل الدخول
1. افتح التطبيق
2. أدخل اسم المستخدم وكلمة المرور
3. اضغط على "تسجيل الدخول"
4. إذا كان أول تسجيل دخول، ستظهر نافذة تغيير كلمة المرور

### إدارة المستخدمين
1. سجل الدخول كمدير
2. اذهب إلى "إدارة المستخدمين"
3. يمكنك:
   - إضافة مستخدم جديد
   - تعديل معلومات المستخدم
   - تعيين الدور
   - تفعيل/تعطيل المستخدم
   - إعادة تعيين كلمة المرور
   - حذف المستخدم

### تعيين الصلاحيات
1. في صفحة إدارة المستخدمين
2. اضغط على "تعديل" للمستخدم
3. حدد الصلاحيات لكل صفحة:
   - عرض
   - إنشاء
   - تعديل
   - حذف

## الأمان

### تشفير كلمات المرور
- يتم تشفير كلمات المرور باستخدام bcrypt
- لا يتم تخزين كلمات المرور بشكل نصي

### الجلسات
- يتم تخزين معلومات الجلسة في localStorage
- تنتهي الجلسة عند تسجيل الخروج
- يتم التحقق من الجلسة عند كل طلب

### الحماية من الهجمات
- التحقق من صحة البيانات المدخلة
- منع SQL Injection
- حماية من XSS
- التحقق من الصلاحيات على مستوى الخادم

## استكشاف الأخطاء

### لا يمكن تسجيل الدخول
1. تحقق من اتصال قاعدة البيانات
2. تأكد من وجود جدول المستخدمين
3. تحقق من اسم المستخدم وكلمة المرور

### لا تظهر صفحة إدارة المستخدمين
1. تأكد من تسجيل الدخول كمدير
2. تحقق من الصلاحيات في قاعدة البيانات

### خطأ في تغيير كلمة المرور
1. تأكد من إدخال كلمة المرور القديمة بشكل صحيح
2. تحقق من قوة كلمة المرور الجديدة (8 أحرف على الأقل)

## التطوير المستقبلي

### ميزات مقترحة
- [ ] المصادقة الثنائية (2FA)
- [ ] تسجيل الدخول باستخدام البريد الإلكتروني
- [ ] سجل نشاط المستخدمين
- [ ] إشعارات تغيير كلمة المرور
- [ ] قفل الحساب بعد محاولات فاشلة
- [ ] انتهاء صلاحية كلمات المرور
- [ ] سياسات كلمات المرور المخصصة

## الدعم
للمساعدة أو الإبلاغ عن مشاكل، يرجى التواصل مع فريق التطوير.
